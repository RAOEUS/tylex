#!/bin/bash
#
# tylex-add: Launch rofi/dmenu to add a new text expansion,
# skipping if the same key already exists,
# and sending desktop notifications so you always get feedback.

# — ensure notifications work from inside rofi/dmenu —
export XDG_RUNTIME_DIR="/run/user/$(id -u)"
export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
export DISPLAY="${DISPLAY:-:0}"
export XAUTHORITY="${XAUTHORITY:-$HOME/.Xauthority}"

# — XDG directories —
XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}
XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}

CONFIG_DIR="$XDG_CONFIG_HOME/tylex"
DATA_DIR="$XDG_DATA_HOME/tylex"
CONFIG_FILE="$CONFIG_DIR/config.sh"
EXP_FILE="$DATA_DIR/expansions.json"

# load user overrides if present
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

# auto‐detect rofi or dmenu
if [ -z "$LAUNCHER" ]; then
  if command -v rofi &>/dev/null; then
    LAUNCHER="rofi -dmenu -i"
  else
    LAUNCHER="dmenu -i"
  fi
fi

# ensure data file exists
mkdir -p "$DATA_DIR"
[ -f "$EXP_FILE" ] || echo '[]' > "$EXP_FILE"

# prompt for abbreviation (key)
key=$(echo | eval "$LAUNCHER" -p "New abbreviation:")
# trim whitespace
key="$(echo -n "$key" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
[ -z "$key" ] && exit 0

# prompt for expansion (value)
value=$(echo | eval "$LAUNCHER" -p "Expansion for '$key':")
value="$(echo -n "$value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
[ -z "$value" ] && exit 0

# if key already exists, skip
if jq -e --arg k "$key" 'any(.[]; .key == $k)' "$EXP_FILE" >/dev/null; then
  notify-send "Tylex" "Snippet '$key' already exists; skipping."
  exit 0
fi

# append new snippet
tmp_file="$(mktemp)"
jq --arg k "$key" --arg v "$value" '
  . + [{ key: $k, value: $v, usage: 0 }]
' "$EXP_FILE" > "$tmp_file" && mv "$tmp_file" "$EXP_FILE"

notify-send "Tylex" "Added snippet '$key' → '$value'."

